---
title: "Predicting District School Funding and Educational Outcomes"
author: "Team Po-Data Science: Amy Luo, Austin Tucker, Han Choi, Juliet McCann, Yeeun Lee"
date: "December 2021"
output:
  html_document:
    theme:
      bootswatch: 'cosmo'
    df_print: paged
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r include=FALSE}
#loading all necessary R Packages
library(haven)
library(dplyr)
library(missForest)
library(caret)
library(kableExtra)
library(rpart)
library(rpart.plot)
library(tree)
library(MASS)
library(caret)
library(tidyverse)
library(stargazer)
```


## Overview and Motivation
*Provide an overview of the project goals and the motivation for it. Consider that this will be read by people who did not see your project proposal.*
In our project, we use the SEDA dataset that maps student achievement based on different district level covariates. The [Educational Opportunity Project at Stanford University](https://edopportunity.org/) measures educational opportunity in diverse communities all over America. We loaded the file from the publicly available datasets that the SEDA project has online [here](https://exhibits.stanford.edu/data/catalog/db586ns4974) We use the inner join function to join the achievement scores dataset and the covariates dataset.

## Related Work
*Anything that inspired you, such as a paper, a web site, or something we discussed in class.*

## Initial Questions
*What questions are you trying to answer? How did these questions evolve over the course of the project? What new questions did you consider in the course of your analysis?*


## Part 1: Predicting District Academic Achievement

In the first part of our project, we aim to understand the variables that predict academic achievement on a district level. This section of our project has three components. First, we will use explortory data analysis and machine learning modeling to determine key predictors of academic achievment on which to focus. Next we will take a closer look at some socio-economic status, unemployment, and poverty as predictors of academic achievement, using Washington and Massachusetts as case studies. Finally, we will explore how receiving free lunch at school predicts academic success. 


### Data Source:

Data for this portion of the project is obtained from the Stanford

**this still needs to be done-- describing the data source**

```{r}
# Load achievement data (district, CS, pooled) 
# data obtained from: "https://stacks.stanford.edu/file/druid:db586ns4974/seda_geodist_pool_cs_4.0.dta"
# This data set contains data on the outcome of interest, district academic achievement.
# In this data set, academic achievement is measured in terms of standard deviation 
# units and is what we will be using for our regression analyses
ach <- read_dta("seda_geodist_pool_cs_4.0.dta")  

# Load main covariates data (district level), pool 
# data obtained from https://stacks.stanford.edu/file/druid:db586ns4974/district%20covariates.dta"
# This data set contains an extensive list of covariates that will be tested as
# predictors of our outcome, academic achievement
covs <- read_dta("seda_cov_geodist_pool_4.0.dta")


# Merge files together. This keeps only matched districts.
dat <- inner_join(ach, covs, by = c("sedalea", "fips"))


# Subset to the "all" subgroup estimates for all students, only districts
# with an estimate of average achievement, unemployment, poverty, ses avergage, and non-missing SES.
dat <- filter(dat,
              subgroup == "all",
              !is.na(cs_mn_avg_ol),
              !is.na(unempavgall),
              !is.na(povertyavgall),
              !is.na(sesavgall))
nrow(dat)


```

After creating this data set, we noticed that the covariate data set that we used did not include variables related to district spending. This is an area of interest of our team, as it shows how policies and funding can play a round in academic outcomes. Therefore, obtained an additional SEDA dataset with district spending included and merged this with the data set above. 


```{r}

#importing the data set that includes variables of interest: ppexp_tot, ppexp_inst, pprev_tot
spending <- read_dta("district covariates.dta")  

# Subsetting data set to only include variables of interest
# also including the district ID, titled leaid here, and state ID (fips) for joining
spending <- subset(spending, select = c(ppexp_tot, ppexp_inst, pprev_tot, leaid, fips))

# since the name of the district ID variable in the dataset "spending" (leaid) is different
# from the district ID variable in the data set "dat" (sedalea), we need to change this

spending <- rename(spending, sedalea = leaid)

#checking the class of `sedalea` in "spending" df 
class(spending$sedalea)

#checking the class of `sedalea` in "dat" df

class(dat$sedalea)

#converting `sedalea` in "spending" df to numeric class so that they are both of the same class
spending$sedalea <- as.numeric(spending$sedalea)

#confirming that `sedalea` in "spending" is now numeric
class(spending$sedalea)

# Merge files together. This keeps only matched districts.
dat <- inner_join(dat, spending, by = c("sedalea", "fips"))
```


### Part 1a: Deciding the predictors of interest

### Explorotory Analysis

For the exploratory data analysis, we start by summarizing our outcome of interest: district academic achievement. As mentioned in the code above, the data set that we imported for our measures academic achievement in terms of standard deviation units away form the national mean. While we can compare relative performance using this measure, interpreting standard deviation units for exploratory data analysis is not too useful, and can be difficult to interpret. Therefore, we will import another SEDA dataset that measures academic achievement outcomes in terms of "grade levels" using the variable `gcs_mn_avg_ol.`

As with `cs_mn_avg_ol`, this variable indicates the average math and reading scores for grades 3  through 9 from academic years 2008-2009 to 2015-2016. This scale, however, is in "grade levles" where 5.5 is average across all districts (mid point of grades 3 and 8, the grades that participate in testing). Using this scale means that if a district has an average grade level of 7.5, their students math and reading scores are, on average, similar to students who are one grade level higher, when compared to an average district in the nation. 


```{r}
# loading SEDA data that includes academic achievement in "grade levels"

ach.EDA <- read_dta("seda_geodist_pool_gcs_4.0.dta")  

ach.EDA <- filter(ach.EDA,
              subgroup == "all",
              !is.na(gcs_mn_avg_ol))

```

To begin our exploratory data analysis on our outcome, it would be helpful to first take a look at how much variation we have in our data. We can visualize this first by using a histogram.

```{r}

ggplot(aes(x=gcs_mn_avg_ol), data = ach.EDA) +
  geom_histogram(color="black", fill="#99CCFF") +
  xlab("Average Test Scores (Grade Levels)") +
  ylab("Frequency")

```

From the histogram above, we see that there is decent amount of variation in the district average achievement scores, as measured in "Grade Levels." For example, some districts have average test scores of around 2.5-- that means that district is testing 3 grade levels below the national average of 5.5! On the other hand, there are also some very high achieving districts. For example, some districts have average test scores at around 7.5 grade levels, 2.5 grade levels above the national average. 

Our team is hoping to understand some of the district-level factors that leads to such variation in academic performance in the United States. 

Before moving onto our analysis, we can also look at the variation in test scores between and within states using box plots:

```{r}

ach.EDA %>% mutate(stateabb = reorder(stateabb, gcs_mn_avg_ol, FUN = median)) %>% 
  ggplot(aes(stateabb, gcs_mn_avg_ol, group = stateabb)) + 
  geom_boxplot(fill = "#99CCFF") +
  labs(x = "State Abbreviation", y = "Average District Test Scores (Grade Levels)") + theme(axis.text.x = element_text(angle = 90, hjust = 1)) 



```

From the graph above, we notice there is a lot of variation in test scores both between and within states. Districts in Massachusetts have the highest median test score, performing at about 1.5 grade levels above the national average while New Mexico has the lowest median achievement scores with a median of around 0.5 grade levels below the national average. With that being said, within most states there is a lot of variation in performance. Within a given state, take California for example, you can find districts with both extremely high and extremely low test scores.

In our analysis, we hope to understand the factors that contribute to such variation between districts across the United States. The covariate data set has many different variables, many of which may predict district test scores. However, for the purpose of our project, we want to focus in on a few key covariates in order to produce more focused and meaningful conclusions.

To decide our priority predictors, we can start of by visually summarizing the overall relationships between these variables and our outcome for academic achievement, `cs_mn_avg_ol`. In contrast our achievement variable used in the plots above, `cs_mn_avg_ol` measures academic achievement in terms of standard deviations away from the national average. 

Before we begin, it would be helpful to summarize create a list of our predictors for this analysis. The covariates we are exploring include: 

- `urban`: if the district is in a city/urban locale (binary; 0 = no, 1 = yes)
- `avgrdall`: average per grade enrollment (number of students)
- `perfrl`: percent free lunch in the grade (percentage; range: 0-1)
- `perell`: % of all students in the district that are English Language Learners (ELL ) (percentage; range: 0-1)
- `perspeced`: % of all students in the district that qualify for Special Education (percentage; range: 0-1)
- `nsch`: number of schools in district (count)
- `aides`: number of instructional aides (count)
- `corsup`: number of instructional coordinators and supervisors (count)
- `elmgui`: number of Elementary Guidance Counselors (count)
- `stutch_all`: pupil teacher ratio (ratio of number of pupils to number of students in district)
- `ppexp_tot`: total per pupil expenditures (dollars)
- `ppexp_inst`: total per pupil expenditures on instruction (dollars)
- `pprev_tot` : revenue per pupil (dollars)
- `baplus_all`: % of adults in district with at least a bachelors degree (percentage)
- `poverty517_all`: % of households with 5-17 year olds in poverty (percentage)
- `singmom_all` % of household with children with single mom (percentage)
- `snap_all` : % of households receiving snap benefits (percentage)
- `samehouse_all`: % of households living in the same house as last year (percentage)
- `unemp_all` : % unemployed in the district (percentage)
- `inf_fem`: percent of 25 - 64 year old females in labor force (percentage)
- `teenbirth_all`: percent of 15-19 year olds giving birth in district (percentage)
- `sesall`: standardized socio-economic status composite score computed as the first principal component factor score of the following measures: median income, percent with a bachelor's degree or higher, poverty rate, SNAP rate, single mother headed household rate, and unemployment rate 
- `cs_mn_avg_ol`: District test-based achievement math and reading scores from ordinary least quares estimate

**NOTE TO OTHERS-- IM STILL WORKING ON THIS SECTION-- I CHANGED  MY LIST OF PREDICTORS TO JUST INCLUDE THE ONES FROM THE "COVS" DATA SET PLUS THE EXPENDITURE ONES SO THE ABOVE LIST AND THE BELOW GRAPHS ARE NOT APPLICABLE. I WILL FIX THIS AND UPDATE WHENEVER THERES A GAP IN PEOPLE WORKING ON THE .RMD PLEASE CARRY ON :)**

**Oh and i will also make the scatter plots below look better dw**

For the continuous predictors, we can do scatter plots:
```{r}
ML.dta <- read.csv("complete_data_ML.csv")

ML.dta %>% 
  gather(predictor, value, c(avgrdall, perfrl, perell, perspeced, nsch, aides,
                             corsup, elmgui, stutch_all, ppexp_tot, ppexp_inst, 
                             pprev_tot, baplus_all, poverty517_all, singmom_all, 
                             snap_all, samehouse_all, unemp_all, inlf_fem, 
                             teenbirth_all, sesall)) %>% 
  ggplot(aes(x = value, y = cs_mn_avg_ol)) + 
  geom_point() + 
  facet_wrap(~ predictor, scales = 'free_x') + 
  xlab(NULL) + ylab("District Achievement Scores")
```
For the binary predictor (`urban`), we can use a box plot:

```{r}

```

Our above scatter plots confirm what we initially suspected: many of these variables do in fact predict academic achievement. For example, it appears `baplus_all`, the percent of adults in the district with a bachelor's degree, is positively correlated with academic achievement. On the other hand, the percent of households in poverty or with a single mother appear to be negatively correlated. For other variables, such as per pupil expenditure (`ppexpt_inst`), the association is less clear. Overall, while these scatterplots give us a general sense of what variables may be important, it still is not clear which variables matter the most for academic achievement.

To answer this question, we will turn to machine learning models. We will first use random forest to determine variables of importance in predicting academic achievement, as measured by the Gini coeffient. We will then addition use a regression tree to see which variables are included to predict relative test scores. 

## Using Machine Learning to Determine Predictors of Importance
### Creating the Training and Test Sets
To begin our machine learning exercises, we first must great our training and test sets. Here we are using training and test sets that both include 50% of the dataset.
```{r}
#creating a data partition that splits my data frame in half
index_train<- createDataPartition(y = ML.dta$low_dist_ach, times =1, p=0.05, list = FALSE)

#labeling the first "slice" as the train set
train_set <- slice(ML.dta, index_train)

#labelign the second "slice" as the test set
test_set <- slice(ML.dta, -index_train)
```


### Random Forest
Next, we will use a Random Forest Model to determine variables of importance, as measured using the Gini Coefficient. 


```{r}
set.seed(1)

#fitting a random forest with all 22 predictors
rf_fit <- randomForest(cs_mn_avg_ol ~ urban + avgrdall + perfrl + perell + perspeced + nsch + aides + corsup + elmgui + stutch_all + ppexp_tot + ppexp_inst + pprev_tot + baplus_all + poverty517_all + singmom_all + snap_all + samehouse_all + unemp_all + inlf_fem + teenbirth_all + sesall, data = train_set, mtry = 22, importance = TRUE)


variable_importance <- importance(rf_fit)

variable_importance_death <- tibble(Predictor = rownames(variable_importance),
                  Gini = variable_importance[,1]) %>%
                  arrange(desc(Gini))

kable(variable_importance_death[1:22,])

#predicting probability of estimates for test set
probs_rf <- predict(rf_fit, newdata = test_set, type = "class")

#converting probabilities to predicted response labels

y_hat_rf <- ifelse(probs_rf > 0.5, 1, 0)

#obtaining the confusion matrix

confusionMatrix(data = as.factor(y_hat_rf), 
                reference = as.factor(test_set$low_dist_ach), 
               positive = "1")

```

From the above outputs we can see two things. First, our random forest model is fairly accurate at predicting test scores with an accuracy of 80.47%. Second, as measured by the Gini coefficient, percent free lunch is the most important predictor of test scores followed by percent of adults who have their bachelors degree. Other important indicators include socio-economic status and poverty. 

### Regression Tree

To supplement the above results from the random forest, we can also fit our data to a regression tree model. 
```{r}
tree = tree(cs_mn_avg_ol ~ urban + avgrdall + perfrl + perell + perspeced + 
              nsch + aides + corsup + elmgui + stutch_all + ppexp_tot + 
              ppexp_inst + pprev_tot + baplus_all + poverty517_all + 
              singmom_all + snap_all + samehouse_all + unemp_all + 
              inlf_fem + teenbirth_all + sesall, data = train_set)  

summary(tree)


```

As seen in teh above output, the regression tree only ened up including three variables in the tree construction: percent of students receiving free lunch (`perfrl`), percent of adults with at least a bachelors degree (`baplus_all`), and percent of students who are english language learners (`perell`).

```{r}
plot(tree, type = "uniform")
text(tree, cex = 1)
```

**Need to add tree conclusions**

So based on these analyses, what predictors should we focus on? It is clear from the random forest and the regression tree models that some variables are more important for academic success than others. For example, percent of students receiving free lunch has high priority in both the random forest model and the regression tree models so warrants attention in future analyses. We additionally want to balance the outcomes of this exploratory data analysis with the interests of our team members. For example, socio-economic status and related predictors, such as poverty and unemployment, are often described as strong predictors of academic success (*source?*). Therefore, it would also be worthwhile to explore these variable further and the nature of their associations with academic achievement outcomes. 

Therefore, we explore different covariates of interest that highly correlate with average district academic achievement, relative to the national mean measured in standard deviation units, including unemployment, free lunch, SES, and poverty. In this section we look at poverty, unemployment, and SES composite scores.

## Summary statistics and correlations
To reiterate what we was mentioned above, we use a stargazer to observe the mean and standard deviations of each variable and then review the correlation between each of the unemployment, SES scores, poverty, and average academic achievement variables. We see that SES, poverty, and unemployment are all highly correlated with one another as expected. Furthermore, we observe that all three variables are correlated with average academic achievement with SES and average test scores having a correlation of 0.76, unemployment and average academic achievement have a negative correlation of -0.57 and poverty and average academic achievement also having a negative correlation of -0.67.

```{r}
dat2 <- dat %>%
  group_by(stateabb) %>%
  summarise(ses = mean(sesavgall), poverty = mean(povertyavgall), unemployment = mean(unempavgall))


stargazer(data.frame(dplyr::select(dat, cs_mn_avg_ol, unempavgall, povertyavgall, sesavgall)),
          type="text")

#correlation between outcome and unemployment, poverty, and ses
round(cor(dplyr::select(dat, cs_mn_avg_ol, unempavgall, povertyavgall, sesavgall)), 2)
```


## Variation in each variable

After seeing the descriptive statistics of each variable, we plot histograms of unemployment, SES scores, poverty, and average academic achievement to display the distribution of each variable. SES is measured as "sesavgall" which is the SES composite score for all families in the district between 2005-2009 and 2014. "povertyavgall" represents the poverty rate (eb estimate) of all families in the district between 2005-2009 and 2014 and the "unempavgall" represents the unemployment rate (eb estimate) of all families in the district between 2005-2009 and 2014. We create histogram and annotate them with the means and standard deviations of each variable. We see that poverty, academic achievement, and SES all have wider spreads of variation and the distribution of unemployment seems to be more narrow. 

```{r pressure, echo=TRUE}
# How much variation is there in average academic achievement?
ggplot(aes(x=cs_mn_avg_ol), data = dat) +
  geom_histogram(color="black", fill="cyan2", binwidth = 0.05) +
  annotate("text", x=-1.8, y=750, label = "Mean=0.021, SD=0.33",
           size=5, hjust=0, vjust=0) +
  xlab("Average Test Scores (Grade 5.5, CS Scale)") +
  ylab("Frequency") +
  theme_classic()

# How much variation is there in unemployment?
ggplot(aes(x=unempavgall), data = dat) +
  geom_histogram(color="black", fill="lightsalmon1", binwidth = 0.005) +
  annotate("text", x=-0.15, y=1010, label = "Mean=0.06 , SD=0.02",
           size=5, hjust=0, vjust=0) +
  xlab("Average Unemployment") +
  ylab("Frequency") +
  theme_classic()

# How much variation is there in poverty?
ggplot(aes(x=povertyavgall), data = dat) +
  geom_histogram(color="black", fill="darkolivegreen3", binwidth = 0.01) +
  annotate("text", x=0.21, y=600, label = "Mean = 0.126, SD=0.062",
           size=5, hjust=0, vjust=0) +
  xlab("Average Poverty") +
  ylab("Frequency") +
  theme_classic()

# How much variation is there in SES?
ggplot(aes(x=sesavgall), data = dat) +
  geom_histogram(color="black", fill="blueviolet", binwidth = 0.1) +
  annotate("text", x=-3.5, y=500, label = "Mean = 0.33, SD=0.85",
           size=5, hjust=0, vjust=0) +
  xlab("Average SES") +
  ylab("Frequency") +
  theme_classic()

```

## Plots of Association

Now we want to utilize ggplot to plot the association between the three socioeconomic factors including unemployment, SES scores, and poverty with average academic achievement. We also obtain a pearson correlation coefficient (r) for each graph and annotate it on the plot. Each point represent a district and the size of each point is the total enrollment between grades 3-8 in that district. Lastly, we draw a non-linear line that follows the trajectory of our data points. In the first plot, we see that there is a negative association between unemployment and average district academic achievement. Our r= -0.57. Similarly in the next plot, we also observe that there is a negative association between poverty and average district academic achievement with an r = -0.67. In the last plot, we see that there is actually a positive association between SES and average district academic achievement with the highest correlation coefficient of r = 0.76. 

```{r}
# What is the association between unemployment and average academic achievement?
r1 <- round(cor(dat$cs_mn_avg_ol, dat$unempavgall),2)
ggplot(aes(x=unempavgall, y=cs_mn_avg_ol), data = dat) +
  geom_point(alpha = 0.3, pch=21, color = "black", fill = "lightsalmon1", aes(size = totenrl)) +
  geom_smooth(se=F, lwd=0.5, lty=2, method="lm", formula = y~poly(x,3)) +
  annotate("text", x=0.03, y=-1.5, hjust=1, vjust=0,
           label = paste0("r=",r1)) +
  scale_size(range = c(1,30)) +
  guides(size="none") +
  ggtitle("What is the association between Unemployment and average academic achievement?") +
  xlab("Average Unemployment") +
  ylab("Average Test Scores (Grade 5.5, CS Scale)")

# What is the association between poverty and average academic achievement?
r2 <- round(cor(dat$cs_mn_avg_ol, dat$povertyavgall),2)
ggplot(aes(x=povertyavgall, y=cs_mn_avg_ol), data = dat) +
  geom_point(alpha = 0.3, pch=21, color = "black", fill = "darkolivegreen3", aes(size = totenrl)) +
  geom_smooth(se=F, lwd=0.5, lty=2, method="lm", formula = y~poly(x,3)) +
  annotate("text", x=0.05, y=-1.5, hjust=1, vjust=0,
           label = paste0("r=",r2)) +
  scale_size(range = c(1,30)) +
  guides(size="none") +
  ggtitle("What is the association between poverty and average academic achievement?") +
  xlab("Average Poverty") +
  ylab("Average Test Scores (Grade 5.5, CS Scale)")

# What is the association between SES and average academic achievement?
r3 <- round(cor(dat$cs_mn_avg_ol, dat$sesavgall),2)
ggplot(aes(x=sesavgall, y=cs_mn_avg_ol), data = dat) +
  geom_point(alpha = 0.3, pch=21, color = "black", fill = "blueviolet", aes(size = totenrl)) +
  geom_smooth(se=F, lwd=0.5, lty=2, method="lm", formula = y~poly(x,3)) +
  annotate("text", x=-3, y=0.75, hjust=1, vjust=0,
           label = paste0("r=",r3)) +
  scale_size(range = c(1,30)) +
  guides(size=FALSE) +
  ggtitle("What is the association between SES and average academic achievement?") +
  xlab("Average SES") +
  ylab("Average Test Scores (Grade 5.5, CS Scale)")

```


## Unemployment and Average Academic Achievement 

First, we create boxplots to display the range of the median unemployment rates between all 50 states. Here, we observe that South Dakota has the lowest unemployment rate and Mississippi has one of the highest unemployment rates (excluding DC). Then, Montana seems to have similar unemployment rates compared to Massachusetts. We note this to plot four states that we can compare in terms of their unemployment-academic achievement gradient. 

Next, we found that according to the [Bureau of Labor Statistics](https://www.bls.gov/web/laus/laumstrk.htm), Nebraska has the lowest unemployment rate as of September 2021 at 2.0. Washington and Massachusetts have very similar unemployment rates of 4.9 and 5.2, respectively. Lastly, California has the highest unemployment rate of 7.5. Therefore, we also specifically look at the differences in the unemployment-achievement gradient between Nebraska, Washington, Massachusetts, and California. To start off, we plot the boxplots of unemployment rates for the four states and note the differences in their medians. 

Then, in one of our final plots titled "How does the Unemployment-Achievement gradient differ in WA, MA, NE, and CA?", we notice that CA has a huge range of unemployment rates with the line stretching wide into higher unemployment scores. Meanwhile, the line for Nebraska has a range that stretches into the low unemployment rates. We see that all four lines have negative slopes with higher unemployment rates with lower scores of academic achievement and lower unemployment rates with higher scores of academic achievement. However, when comparing between states, the two lines for CA and NE seem to have very similar slopes that overlap with one another. Massachusetts and Washington have similar ranges of unemployment rates but the line is overall at a higher level. Districts in MA display higher average academic achievement scores in standard deviation units (relative to the national mean) overall compared to CA, NE, and WA.

Finally, in the last plot labeled "How does the Unemployment-Achievement gradient differ in MS, MA, SD, and MT?", we also plot the gradients for the four states of Massachusetts, Montana, South Dakota, and Mississippi specified earlier. Here, we notice that South Dakota has a wide range of unemployment rates that stretch into lower numbers. MT and SD seem to have similar slopes while MS has a slope that is closer to zero. The unemployment-achievement gradient slope seems to be highest in magnitude (most negative) for MA but again, we notice that the average academic achievement scores are higher overall at all unemployment rates compared to all other states. 

We note that there are several flaws in solely using unemployment as a covariate. We believe that there could be additional variation happening that is not just coming from unemployment. For further analyses, we can look at additional covariates of interest that may impact academic achievement such as income earned, % of students receiving free lunch, poverty levels, environmental factors, housing, and social policies. We also ask why Massachusetts has significantly higher scores of academic achievement at every level of unemployment compared to several other states. Perhaps this can be due to the educational system and policies in MA and/or the different programs available to school districts in Massachusetts. Other variables that may impact the academic performance of students in each state include family environments (such as domestic violence and abuse), racism, and other economic and social measures.

```{r}
# The unemployment distribution between all 50 states ordered by the median
p_unempdist <- dat %>% 
  mutate(stateabb = reorder(stateabb, unempavgall, FUN = median)) %>%
  ggplot(aes(stateabb, unempavgall)) +
  geom_boxplot(color = "darkorchid4") +
  #scale_y_discrete() +
  ylim(0, 0.2) +
  scale_x_discrete() +
  theme(axis.text.x = element_text(angle = 90, hjust = 0.5, size = 7)) +
  ggtitle("Distribution of Unemployment rates for each state") +
  xlab("States") +
  ylab("Unemployment Rate")
p_unempdist


# The unemployment distribution between WA vs. MA vs. NE vs. CA
dat %>%
  filter(stateabb == "WA" | stateabb == "MA" | stateabb == "NE" | stateabb == "CA") %>% 
  ggplot() +
  geom_boxplot(aes(x= stateabb, y=unempavgall, fill=stateabb), color = "black", outlier.colour = "navy", outlier.size = 1, notch = FALSE) +
  scale_y_continuous(trans = "sqrt") +
  xlab("") + 
  ylab("Unemployment") +
  theme(legend.position ="none")

# How does the unemployment gradient compare in WA vs. MA vs. NE vs. CA?
dat_wa_ma_ne_ca <- filter(dat, stateabb %in% c("WA","MA", "NE", "CA"))

ggplot(aes(x=unempavgall, y=cs_mn_avg_ol), data = dat) +
  geom_point(alpha = 0.2, pch=21, color = "black", fill = "grey", aes(size = totenrl)) +
  geom_point(alpha=0.7, pch=21, color="black", aes(size=totenrl, fill=stateabb),
             data = dat_wa_ma_ne_ca) +
  geom_smooth(se=F, lwd=0.5, lty=2, method="lm", color="black", aes(fill=stateabb), formula = y~x, 
              data = dat_wa_ma_ne_ca) +
  scale_size(range = c(1,30)) +
  guides(size="none", color="none") +
  labs(fill = "State") +
  ggtitle("Unemployment-achievement points in WA, MA, NE, and CA?") +
  xlab("Average Unemployment") +
  ylab("Average Test Scores (Grade 5.5, CS Scale)")


ggplot(aes(x=unempavgall, y=cs_mn_avg_ol), data = dat) +
  geom_point(alpha=0.04, pch=21, color="black", aes(size=totenrl, fill=stateabb),
             data = dat_wa_ma_ne_ca, show.legend = FALSE) +
  #geom_smooth(se=F, lwd=0.5, lty=2, method="lm", formula = y~poly(x,3)) +
  scale_size(range = c(1,30)) +
  geom_smooth(se=F, lwd=1, lty=1, method="lm", aes(color=stateabb), formula = y~x,
              data = dat_wa_ma_ne_ca) +
  ggtitle("How does the Unemployment-Achievement gradient differ in WA, MA, NE, and CA?") +
  xlab("Average Unemployment") +
  ylab("Average Test Scores (Grade 5.5, CS Scale)") +
  labs(color = "State")

# How does the unemployment gradient compare in MS vs. MA vs. SD vs. MT?
dat_ms_ma_sd_mt <- filter(dat, stateabb %in% c("MS","MA", "SD", "MT"))

  ggplot(aes(x=unempavgall, y=cs_mn_avg_ol), data = dat) +
  geom_point(alpha=0.04, pch=21, color="black", aes(size=totenrl, fill=stateabb),
             data = dat_ms_ma_sd_mt, show.legend = FALSE) +
  scale_size(range = c(1,30)) +
  geom_smooth(se=F, lwd=1, lty=1, method="lm", aes(color=stateabb), formula = y~x,
              data = dat_ms_ma_sd_mt) +
  ggtitle("How does the Unemployment-Achievement gradient differ in MS, MA, SD, and MT?") +
  xlab("Average Unemployment") +
  ylab("Average Test Scores (Grade 5.5, CS Scale)") +
  labs(color = "State")
```

## Is this relationship specific to unemployment and academic achievement?

Furthermore, we chose to plot the academic achievement by SES composite scores for MA and WA to observe whether we will observe a difference in the relationship between SES and academic achievement and the relationship between unemployment and academic achievement. We see that there are some differences in the range and the gradient. By simply looking at the points, we notice that Massachusetts and Washington generally overlap in their relationships but MA does seem to have slightly higher levels of SES. 

Massachusetts and Washington may have similar unemployment rates but may look different on other scales such as housing or poverty or income levels. Therefore, we want to consider other covariates, such as % of free lunch, an indicator that our previous regression tree included as a predictor. We saw that the random forest and decision tree model mentioned earlier concludes that percent of students receiving free lunch has high priority in influencing academic achievement. 

```{r}
# How does the SES gradient compare in WA vs. MA?
dat_wa_ma <- filter(dat, stateabb %in% c("WA","MA"))

ggplot(aes(x=sesavgall, y=cs_mn_avg_ol), data = dat) +
  geom_point(alpha = 0.2, pch=21, color = "black", fill = "grey", aes(size = totenrl)) +
  geom_point(alpha=0.7, pch=21, color="black", aes(size=totenrl, fill=stateabb),
             data = dat_wa_ma) +
  geom_smooth(se=F, lwd=0.5, lty=2, method="lm", color="black", aes(fill=stateabb),
              data = dat_wa_ma) +
  scale_size(range = c(1,30)) +
  guides(size=FALSE, color=FALSE) +
  labs(fill = "State") +
  ggtitle("How does the SES-achievement gradient differ in WA and MA?") +
  xlab("Average SES") +
  ylab("Average Test Scores (Grade 5.5, CS Scale)")

```

*Next we further explore the relationship between academic achievement and socioecnomic factors by looking at the percent of students receiving free lunch_____ please continue on from here! hwaiting ye eun!*





---

## Part 2: Congressional District, Political Leaning, and School Funding

---

#### Setting the Stage

Over this past year, states and local governments have begun a one-a-decade process of drawing new voting district boundaries. This redistricting uses population and demographic data from the census conducted by the Census Bureau, with the most recent occurring in 2020.

The redistribution process was created to accurately reflect how communities change over time in the US legislative system. Maps are redrawn to ensure that districts are equally populated and representative of the district’s population. When done correctly and equitably, redistricting is a window for the political electoral processes to adapt to constituent demographics accurately, ensuring that constituents are accurately represented in local, state, and national legislation. In the words of John Adams, “an exact portrait, a miniature” of the people and communities grouped geographically.

Yet, redistricting has become the most pressing threat to democracy. As described by the [Brennan Center](https://www.brennancenter.org/our-work/research-reports/gerrymandering-explained): 

>> But sometimes the process is used to draw maps that put a thumb on the scale to manufacture election outcomes that are detached from the preferences of voters. Rather than voters choosing their representatives, gerrymandering empowers politicians to choose their voters. This tends to occur especially when linedrawing is left to legislatures and one political party controls the process, as has become increasingly common. When that happens, partisan concerns almost invariably take precedence over all else. That produces maps where electoral results are virtually guaranteed even in years where the party drawing maps has a bad year.

Alongside a [2019 Supreme Court](https://www.brennancenter.org/our-work/court-cases/rucho-v-common-cause)  ruling that **prohibits redistricting to be challenged in federal court**, this reaffirms major threats to health, education, and social safety net policies at state and national levels, further heightened midst a time of deep divisive partisanship in the United State\

---

![How Gerrymadering Manipulates District Boundaries](How_to_Steal_an_Election_-_Gerrymandering.svg.png){width=75% height=75%}
[Image source](https://www.fairvote.org/new_poll_everybody_hates_gerrymandering)

---

#### In summary,\
- Rigged maps **make elections less competitive**, severely dampening the voices and political voices of all Americans

- Both historical and current residential segregation means that **marginalized communities are the targets of pointed redistricting**; effectively creating a tool for parties to slice and dice districts in ways that discriminate against communities of color

- **Gerrymandering is getting worse.** Applying data science to work, intricate computer algorithms, and sophisticated data on voter patterns have allowed political gamesmanship to “maximize” partisan benefit

---

### Intial Questions

As a part of a larger exploration of the **impact of educational and social safety net policies and sociodemographic characteristics at the state and school district levels on predictors of student success.** We apply the SEDA data set to provide a comprehensive picture of factors at the family, district, and state-level factors that we hypothesize influence student educational outcomes.

To prime further data analyses, the objective of this first portion is to investigate the differences, if any, in school district expenditure between political preferences at the Congressional District level.

#### Specifically,

##### Does spending on school districts differ by political ideology?

The analyses below highlight differences by drawing from data on per student expenditure and per teacher expenditures. This was facilitated at the Congressional District level to capture the granularities unafforded when looking at state-only levels.

An interactive map facilitates this comparison by grouping dominant political preferences and expenditure per student and teacher averaged over school districts in a Congressional District.

As mentioned in class, 

> Plots of maps can be very powerful, very informative and very aesthetically pleasing visualizations.

The goal was to be able to provide a compelling story using nationally representative data.

All in all, we hope that this work underscores the potential impact of gerrymandering on students and teachers by visualizing differences in spending in education for grades 3-8 based on the dominant political ideology in Congressional districts.

---

### Data Sources

**School Expenditure data** are available from: https://exhibits.stanford.edu/data/catalog/db586ns4974

**Political Ideology data** are available from: https://americanideologyproject.com/

- For further background on how constituent policy preferences were measured, please see this paper by [Tausanovitch and Warshaw (2013)](https://americanideologyproject.com/JOP_Tausanovich_Warshaw_2013.pdf) 

Variables of interest include:\

- *leaid* : NCES Local Education Agency (District) Code\
- *year* : spring of school year\
- *grade* : grade level\
- *cdcode*, *cd_fips* : congressional district code\
- *ppexp_tot* : total per pupil expenditures; tot exp/enrolled\
- *ppexp_inst* : instruction expenditures; instr exp/enrolled\
- *mrp_mean* : mean policy preferences of citizens in every congressional district estimates using multilevel regression with poststratification

---

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Packages
library(haven)
library(dplyr)
library(USAboundaries)
library(dplyr)
library(sf)
library(leaflet)
library(dplyr)
library(sp)
library(ggplot2)
library(stringr)
library(dplyr)
library(kableExtra)
library(plyr)
library(systemfonts)
```


### Background: Party Platform Positions on Education 

This question arose to compare the two major parties – Democrats and Republicans – to illuminate how political platforms and values have direct impacts at the level of school districts.\

An overview of the party education platforms is included below:

```{r echo=FALSE, message=FALSE, warning=FALSE}
tabd <- read.csv('Amy_Table.csv')
tabd %>%
  kbl(caption="Comparison between Dem and GOP platforms for K-12 education",
      format= "html",
      col.names = c("Topic","Democrat","Republican"),
                  align="l",) %>%
  column_spec(2, background = 'aliceblue') %>%
  column_spec(3, background = 'mistyrose') %>%
  row_spec(0, bold =T, background='lightgrey', color='black') %>%
  kable_paper(bootstrap_options = c("striped", "hover", "condensed", "responsive"),
              full_width = F,
              html_font = "calibri",
              fixed_thead = T,
              position = 'center') %>%
  column_spec(1,bold=T, border_right =T) %>%
  footnote(general='https://www.ascd.org/blogs/what-the-democrats-and-republicans-stand-for-on-education-excerpts-from-party-platforms',
           general_title="Source: ") %>%
  scroll_box(width = "100%", height = "650px")
```

---

### Exploratory Analyses: Mapping Constituent Ideology by Congressional District

To begin, we first must accurately delineate between politically right and left Congressional districts.\

Here, we applied estimates of political preferences from a collection of survey measures to capture the distribution of political preferences **based on those living in an geographic area**.\

This was purposeful. As mentioned above, one concern we had was that, as a result of gerrymandering, relying only on the election results and the parties of Congressional representatives may underweight the true distribution of political preferences among those living in the District. Therefore, we drew from an opensource project, The American Ideology project, (Tausanovitch and Warshaw, 2013)[https://americanideologyproject.com/], to:

1. Explore the distribution of political preferences by geographic regions, and  
2. The magnitude, or "how radical" preferences are.

```{r echo=TRUE, message=FALSE, warning=FALSE, dpi = 200}
# Loading USAboundaries from GitHub
devtools::install_github("ropensci/USAboundaries")
devtools::install_github("ropensci/USAboundariesData")

# Using USAboundaries package, load the spatial data 2010-2020 Congressional districts
spatial <- us_congressional()


# Loading congressional ideology data for the 113th Congress from The American Ideology Project, https://americanideologyproject.com/
ideology <- read.csv('cd_113_TW_ideology_estimates.csv')


# Joining political ideology data with the spatial data
## String processing spatial dataset to remove leading zeros in "geoid"
spatial <- spatial %>% # Removing Alaska, Hawaii, and Puerto Rico
  mutate(cd_fips = str_remove(spatial$geoid, "^0+")) %>% 
  filter(state_abbr != 'AK') %>%
  filter(state_abbr != 'HI') %>%
  filter(state_abbr != 'PR')

## Selecting columns of interest from ideology dataset
ideology <- ideology %>%
  dplyr::select(c('cd_fips', 'mrp_mean', 'pres_2012')) %>%
  mutate(cd_fips = as.character(cd_fips))

map <- left_join(spatial, ideology, by = 'cd_fips')

# Mapping
ideology_map <- ggplot() +
  geom_sf(data = map, 
          aes(geometry=geometry, fill=mrp_mean), alpha=2) +
  scale_fill_distiller(palette='RdBu', 
                       limits = c(-1.2,1.2), 
                       direction = -1, 
                       breaks=c(-1,0,1),
                       labels=c('Left','Center','Right'),
                       name='Political Leaning') +
  theme(panel.grid.major = element_blank(), 
        panel.background = element_blank(),
        axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        plot.subtitle = element_text(size=9, color='grey45')) +
  labs(title='Contituent Political Ideology by Congressional District', 
       subtitle = 'Source: The American Ideology Project (Tausanovitch & Warshaw, 2015)')

ideology_map
```

As shown, we do find spatial correlations in political preferences. Politically right Congressional districts are clustered in the Midwest and South, and politically left Congressional districts tend to be located on the coasts.

In addition to, we find that the *extent* to which these districts are right- or left-leaning is not balanced. Districts that are more conservative (or right-leaning), on average, are much greater than liberal (or left-leaning) Districts. In other words, 
**conservative Districts tend to be much more radically so than liberal Districts.**

In addition, we find that the *magnitude* to which these districts are right- or left-leaning is not balanced. Districts that are more conservative (or right-leaning), on average, are much greater than liberal (or left-leaning) Districts. In other words, **conservative Districts tend to be much more radically so than liberal Districts.**\

Now, how does this relate to spending on education?

---

### SEDA Dataset Prep

For the following code, please ensure that you have the Stanford Education Data Archive *codebook_covariates_v1_1.xlsx* installed and available in your working directory

- These data are available for download from https://exhibits.stanford.edu/data/catalog/db586ns4974

To clean the data, we collapsed school districts into their respective Congressional Districts, averaging the per pupil expenditure and per instructor expenditure for a single measure per Congressional District.

```{r message=FALSE, warning=FALSE}
# Loading SEDA dataset
full_data_yr <- read_dta("district by year by grade covariates from acs and ccd master_v1_1.dta")
# full_data_yr1 <- read_dta("https://stacks.stanford.edu/file/druid:db586ns4974/district%20by%20year%20by%20grade%20covariates%20from%20acs%20and%20ccd%20master_v1_1.dta")

# New data frame of variables of interest
dat <- full_data_yr %>% # filtering to 2013
  filter(year ==2013) 

dat <- dat[!duplicated(dat$leaid),] %>% # keeping only one observation per school district (removing grade level layer)
  dplyr::select('leaid','cdcode','ppexp_tot','ppexp_inst')  

dat_na <- sum(is.na(dat$ppexp_tot), is.na(dat$ppexp_inst)) # any NAs?  
x <- is.na(dat$ppexp_inst) 
y <- is.na(dat$ppexp_tot)
nonpaired_na <- sum(any(x != y)) # Confirms that all NA values are paired, so we can remove rows for both ppexp_tot and ppexp_inst combined 
rm(x,y,nonpaired_na, dat_na)

dat <- dat[!(is.na(dat$ppexp_tot)), ] # removing 50 NA values (25 observations)

# Final clean dataset with avg values by Congressional district
dat <- ddply(dat, ~cdcode, transform, ppexp=mean(ppexp_tot),  piexp=mean(ppexp_inst))

seda <- dat[!duplicated(dat$cdcode),] %>% # keeping only one observation per Congressional district
  dplyr::select(-'leaid',-'ppexp_tot',-'ppexp_inst') # dropping school district measures
```

---

#### Exploratory Analysis: Distribution of Education Funding

Now that we’ve delineated between politically right and left Congressional District, we explored **how per student and per teacher spending differs between Districts.**

A layered histogram will suffice. From this we can explore: 

1. How much is invested in students and teachers, scaled using the underlying dispersion of values (in units of standard deviation)

2. How clustered is the spending? i.e. plot skew and spread

But first, we want to compare spending based on the national mean and variance. This provides a way to accurately compare education funding per Congressional district based on the national average across all districts. 

To do such, a scale (standard deviations) was applied to per student and teacher expenditures in the remaining analyses. 

```{r message=FALSE, warning=FALSE, dpi = 200}
# Joining education dataset with map dataset
seda <- seda %>% 
  mutate(cd_fips=as.character(cdcode)) %>%
  dplyr::select(-'cdcode')

map <- left_join(map, seda, by = 'cd_fips') 

# Per pupil Congressional district expenditure
map$z <- scale(map$ppexp)

# Per instructor Congressional district Expenditure
map$z_i <- scale(map$piexp)

# Creating indicator variable for histogram layers
hist <- map %>% 
  mutate(left = ifelse(mrp_mean>0, 'Right', 'Left')) # indicator variable for right (1) and left (0)

hist_na <- sum(is.na(hist$left)) # any NAs for unknown political ideology? 
hist <- hist[!(is.na(hist$left)), ] # removing 1 NA value
rm(hist_na)

# Distribution of per Pupil expenditures by Political Ideology
hist_p <- ggplot(hist, aes(x=z,color=left, fill=left)) +
  geom_histogram(position='identity', alpha = 0.3) +
  scale_color_manual(values=c('steelblue','salmon')) +
  scale_fill_manual(values=c('steelblue','salmon')) +
  scale_x_continuous(breaks=seq(-2,7,1),labels=seq(-2,7,1)) +
  labs(title='Distribution of Per Pupil Expediture',
       x='Scaled (standard deviation units)',
       y='Count',
       fill="Political Leaning") +
  guides(color=F) +
  theme_light()

# Distribution of per Instructor expenditures by Political Ideology
hist_i <- ggplot(hist, aes(x=z_i,color=left, fill=left)) +
  geom_histogram(position='identity', alpha = 0.3) +
  scale_color_manual(values=c('steelblue','salmon')) +
  scale_fill_manual(values=c('steelblue','salmon')) +
  scale_x_continuous(breaks=seq(-2,7,1),labels=seq(-2,7,1)) +
  labs(title='Distribution of Per Instructor Expediture',
       x='Scaled (standard deviation units)',
       y='Count',
       fill="Political Leaning") +
  guides(color=F) +
  theme_light()

## Dropping NAs to calculate group averages
z_avgs <- hist[complete.cases(hist$z),] 
z_i_avgs <- hist[complete.cases(hist$z_i),]
na_z <- sum(is.na(hist$z)) # Ensuring that NAs are properly dropped
na_z_i <- sum(is.na(hist$z_i)) # Ensuring that NAs are properly dropped
rm(na_z, na_z_i)

## Data frame with group averages
mu <- ddply(z_avgs, 'left', summarize, grp.mean=mean(z))
mu_i <- ddply(z_i_avgs, 'left', summarize, grp.mean=mean(z_i))

# Final histogram of per Pupil expenditures by Political Ideology
hist_p <- hist_p + geom_vline(xintercept=mu$grp.mean[1], color='dodgerblue', linetype='dashed') +
  geom_vline(xintercept=mu$grp.mean[2], color='tomato', linetype='longdash'); hist_p

# Final histogram of per Instructor expenditures by Political Ideology
hist_i <- hist_i + geom_vline(xintercept=mu_i$grp.mean[1], color='dodgerblue', linetype='dashed') +
  geom_vline(xintercept=mu_i$grp.mean[2], color='tomato', linetype='longdash'); hist_i
```

From the histogram, we find that, indeed, confirms our hypothesis: **that, as expected from party platforms positions, more conservative districts invest less in students and teachers.**\

- The mean spending is different between districts, with districts that are more left-leaning, on average, investing more in students and teachers.

- In addition, the distribution of spending is less ‘bunched’ in liberal Districts a right skew (meaning there are more districts that spend above the national average in students and teachers).\

Now, let's merge Congressional district boundaries and education spending together in a single visualization.

--- 

### Final Analysis: Mapping Average District Spending by Congressional District

```{r message=FALSE, warning=FALSE, dpi = 130}
# Subsetting for map layers 
right <- map %>%
  subset(mrp_mean >0)
left <- map %>%
  subset(mrp_mean <0)

# Mapping per pupil Congressional District expenditure
palette <- colorBin("Greens", domain = c(-1.5,7), bins = 9)

leaflet(map) %>%
  addProviderTiles(providers$CartoDB.Positron, group='Political') %>%
  addTiles(group='Physical') %>%
  addPolygons(data=right,
               opacity=0.5,
               weight=2,
               color='salmon',
               fillColor = ~palette(z),
              fillOpacity = 1,
               highlight=highlightOptions(weight=3,
                                        color='aliceblue',
                                        bringToFront=T),
              group="Politically Right") %>%
  addPolygons(data=left,
              opacity=0.5,
              weight=2,
              color='steelblue',
              fillColor = ~palette(z),
              fillOpacity = 1,
              highlight=highlightOptions(weight=3,
                                      color='aliceblue',
                                      bringToFront=T),
               group='Politically Left') %>%
  addLayersControl(baseGroups=c('Political', 'Physical'),
    overlayGroups=c('Politically Right', 'Politically Left'),
    options=layersControlOptions(collapsed = F))%>%
  addLegend('bottomright',
            pal=palette,
            values=~z,
            opacity=0.5,
            title='Per Pupil Expenditure, scaled') 

# Mapping per instructor Congressional District Expenditure
palette_i <- colorBin("Greens", domain = c(-1.3,6), bins = 9)

leaflet(map) %>%
  addProviderTiles(providers$CartoDB.Positron, group='Political') %>%
  addTiles(group='Physical') %>%
  addPolygons(data=right,
              opacity=0.5,
              weight=2,
              color='salmon',
              fillColor = ~palette_i(z_i),
              fillOpacity = 1,
              highlight=highlightOptions(weight=3,
                                        color='aliceblue',
                                        bringToFront=T),
              group="Politically Right") %>%
  addPolygons(data=left,
              opacity=0.5,
              weight=2,
              color='steelblue',
              fillColor = ~palette_i(z_i),
              fillOpacity = 1,
              highlight=highlightOptions(weight=3,
                                      color='aliceblue',
                                      bringToFront=T),
               group='Politically Left') %>%
  addLayersControl(baseGroups=c('Political', 'Physical'),
    overlayGroups=c('Politically Right', 'Politically Left'),
    options=layersControlOptions(collapsed = F))%>%
  addLegend('bottomright',
            pal=palette_i,
            values=~z_i,
            opacity=0.5,
            title='Per Instructor Expenditure, scaled') 
```

Toggling between the map layers provides an interactive visualization of the geographic distribution of Congressional districts lines and spending on education by political leaning.\

We do indeed find spatial correlations between education spending that aligns with Congressional districts. 

---

#### In summary,

It is clear that investing in students and teachers to ensure that all can access the support needed is critical for equity in education. We find that despite that for right-leaning Districts, the magnitude in which constituent preferences are predominantly sided is much greater than for left-leaning Districts. In other words, Districts that are more left-leaning, are less radically liberal (and more neutral) than right-leaning Districts are radically conservative.\

Yet, left-leaning districts invest more on average in students and teachers, with the leading Districts left-leaning. Further, follow-up analyses may want to look at other outcomes, such as student teacher ratio and proportions of special education students, English language learners, special education teachers, and guidance counselors in school districts between Congressional Districts.
